var chapters = [{
    "chapter":"有理数", "array":[
        {"topic":"负数的定义","pre":{"activities":[{"name":"负数的定义","id":"53c64bc02e2c21e836470974"}]}},
        {"topic":"有理数的概念和分类","pre":{"activities":[{"name":"有理数的概念和分类","id":"53c64c082e2c21e836470975"}]}},
        {"topic":"数轴","pre":{"activities":[{"name":"数轴","id":"53c64c5f2e2c21e836470976"}]}},
        {"topic":"相反数","pre":{"activities":[{"name":"相反数","id":"53c64d1e2e2c21e836470977"}]},"special":{"activities":[{"name":"相反数的性质","id":"53d86ec3af3249f2747d7000"}]}},
        {"topic":"绝对值","pre":{"activities":[{"name":"绝对值","id":"53c64d6a2e2c21e836470978"}]},"special":{"activities":[{"name":"绝对值（含字母）","id":"53c799972e2c21e836470e27"}]}},
        {"topic":"有理数四则运算介绍","pre":{"activities":[{"name":"有理数四则运算介绍","id":"53c79a572e2c21e836470e28"}]}},
        {"topic":"有理数的加法","pre":{"activities":[
            {"name":"有理数的加法（同号）","id":"53c64e972e2c21e83647097a"},
            {"name":"有理数的加法（异号）","id":"53c64ee82e2c21e83647097b"}
        ]}},
        {"topic":"有理数的减法","pre":{"activities":[{"name":"有理数的减法","id":"53c64f5f2e2c21e83647097c"}]}},
        {"topic":"有理数的加减混合运算","pre":{"activities":[{"name":"有理数的加减混合运算1","id":"53c72de52e2c21e83647098d"}]},"special":{"activities":[{"name":"有理数的加减混合运算3","id":"53ec51011cb4aae95a4b31d2"}]}},
        {"topic":"有理数的乘法","pre":{"activities":[
            {"name":"有理数的乘法（异号）","id":"53c64fc62e2c21e83647097d"},
            {"name":"有理数的乘法（同号）","id":"53c72a382e2c21e836470982"}
        ]}},
        {"topic":"有理数的除法","pre":{"activities":[
            {"name":"倒数","id":"53d86f9baf3249f2747d7009"},
            {"name":"有理数的除法","id":"53c72aa02e2c21e836470983"}]},"special":{"activities":[
            {"name":"有理数的乘除混合运算","id":"53c731252e2c21e836470997"}]}},
        {"topic":"有理数的四则混合运算","pre":{"activities":[{"name":"有理数的加减乘除四则运算","id":"53d87047af3249f2747d7015"}]}},
        {"topic":"有理数的乘方","pre":{"activities":[
            {"name":"乘方运算","id":"53c72b142e2c21e836470984"},
            {"name":"负数的乘方运算","id":"53d5c6f6af3249f2747d49b6"}]},"special":{"activities":[
            {"name":"有理数的乘方混合运算","id":"53c733552e2c21e8364709a3"}]}},
        {"topic":"有理数的四则及乘方混合运算","pre":{"activities":[{"name":"有理数的四则及乘方混合运算顺序","id":"53d870d5af3249f2747d702b"}]},"special":{"activities":[{"name":"有理数的四则及乘方混合运算","id":"53c733a32e2c21e8364709a4"}]}},
        {"topic":"科学记数法","pre":{"activities":[{"name":"科学记数法","id":"53c72b562e2c21e836470985"}]}}
    ]},{
    "chapter":"整式的加减", "array":[
        {"topic":"符号语言和书写规范","pre":{"activities":[{"name":"文字语言化符号语言","id":"53e877c6fba13fad32b92911"}]},"special":{"activities":[{"name":"书写规范","id":"53e87831fba13fad32b92912"}]}},
        {"topic":"单项式","pre":{"activities":[{"name":"单项式","id":"53e990e3fba13fad32b92a91"}]},"special":{"activities":[{"name":"判断单项式","id":"53e990f7fba13fad32b92a92"}]}},
        {"topic":"单项式的系数与次数","pre":{"activities":[{"name":"单项式的系数与次数","id":"53e99112fba13fad32b92a93"}]},"special":{"activities":[{"name":"单项式的系数与次数","id":"53e9912efba13fad32b92a94"}]}},
        {"topic":"多项式","pre":{"activities":[{"name":"多项式","id":"53e9915dfba13fad32b92a95"}]},"special":{"activities":[{"name":"多项式","id":"53e9918dfba13fad32b92a97"}]}},
        {"topic":"升幂降幂","pre":{"activities":[{"name":"升幂降幂","id":"53e99174fba13fad32b92a96"}]}},
        {"topic":"同类项","pre":{"activities":[{"name":"同类项与合并同类项","id":"53e991bcfba13fad32b92a98"}]},"special":{"activities":[{"name":"同类项","id":"53e992aefba13fad32b92a9b"}]}},
        {"topic":"合并同类项","pre":{"activities":[{"name":"合并同类项","id":"53e991dffba13fad32b92a99"}]},"special":{"activities":[{"name":"合并同类项的计算","id":"540e74f8bb122f407143032d"}]}},
        {"topic":"去括号","pre":{"activities":[{"name":"去括号","id":"53e9ad6bfba13fad32b92b47"}]},"special":{"activities":[{"name":"去括号","id":"53e9ad9bfba13fad32b92b48"}]}},
        {"topic":"含字母系数整式的化简","pre":{"activities":[{"name":"整式的加减的化简","id":"53e9ae48fba13fad32b92b4e"}]}},
        {"topic":"先化简再求值","pre":{"activities":[{"name":"先化简再求值","id":"53e9ae60fba13fad32b92b4f"}]}},
        {"topic":"整体代入","pre":{"activities":[{"name":"添括号与整体代入","id":"53eb34de1cb4aae95a4b2f84"}]}},
        {"topic":"找规律","pre":{"activities":[{"name":"又掌握了一门新的外语","id":"541934a0a5f980790573e790"}]}}
    ]},{
    "chapter":"一元一次方程", "array":[
        {"topic":"方程与一元一次方程","pre":{"activities":[
            {"name":"方程与一元一次方程","id":"5433aa8fb97968317c5af31b"}]},"special":{"activities":[
            {"name":"判断一元一次方程","id":"5433aa93b97968317c5af31d"},
            {"name":"玩转一元一次方程定义","id":"5433aa95b70f2e237c5e5e84"}]}},
        {"topic":"找等量关系列方程","pre":{"activities":[{"name":"找等量关系列方程","id":"5433aa97b70f2e237c5e5e86"}]}},
        {"topic":"等式的性质","pre":{"activities":[{"name":"等式的性质","id":"5433ba39b97968317c5b5a8b"}]}},
        {"topic":"合并同类项、移项解方程","pre":{"activities":[{"name":"合并同类项、移项解方程","id":"5433ba3fb70f2e237c5ec0cf"}]}},
        {"topic":"去括号、去分母解方程","pre":{"activities":[{"name":"去括号、去分母解方程","id":"5433ba45b97968317c5b5a91"}]},"special":{"activities":[{"name":"去小数分母解方程","id":"5433ba57b97968317c5b5bfd"}]}},
        {"topic":"方程的解","pre":{"activities":[{"name":"方程的解","id":"5433ba5fb97968317c5b5c32"}]}},
        {"topic":"带你围观应用题上","pre":{"activities":[
            {"name":"带你围观应用题上","id":"5433bc10b97968317c5b7135"}]},"special":{"activities":[
            {"name":"总和怪题","id":"543b8ec73bfd788a03c64246"},
            {"name":"变差怪题","id":"543b8ece3bfd788a03c64432"}]}},
        {"topic":"带你围观应用题下","pre":{"activities":[{"name":"带你围观应用题下","id":"543b8ec13bfd788a03c640b6"}]},"special":{"activities":[{"name":"对等怪题","id":"543b8ed44d4d5b8803f1f1c5"}]}}
    ]},{
    "chapter":"实数", "array":[
        {"topic":"平方根","pre":{"activities":[{"name":"平方根","id":"546480fc137e48c722de8ff2"}]}},
        {"topic":"算数平方根","pre":{"activities":[
            {"name":"算数平方根","id":"54648103e0d39bdc2251368f"}]},"special":{"activities":[
            {"name":"求平方根","id":"5464813dc4d33abb22bcfc55"},
            {"name":"非负性","id":"5464816e6dc71d4122c8b1b4"}]}},
        {"topic":"立方根","pre":{"activities":[{"name":"立方根","id":"546480f4e0d39bdc2251368d"}]},"special":{"activities":[{"name":"利用方根的定义解方程","id":"54648101e0d39bdc2251368e"}]}},
        {"topic":"根号2也有组织","pre":{"activities":[{"name":"根号2也有组织","id":"546481a9c4d33abb22bcfcca"}]}},
        {"topic":"实数的相反数绝对值和简单运算","pre":{"activities":[
            {"name":"实数的相反数绝对值和简单运算","id":"546481b61603e4db22595c72"}]},"special":{"activities":[
            {"name":"无理数的估算和比来比去","id":"546481a26dc71d4122c8b1b8"},
            {"name":"无理数的整数部分和小数部分","id":"546481afa727825d224b2f5d"}]}}
    ]},{
    "chapter":"三角形", "array":[
        {"topic":"三角形的分类","pre":{"activities":[{"name":"三角形的概念","id":"538fe2a576cb8a0068b14035"}]}},
        {"topic":"三角形的三边关系","pre":{"activities":[{"name":"三角形的三边关系","id":"539000fa76cb8a0068b14143"}]}},
        {"topic":"三角形的高","pre":{"activities":[{"name":"三角形的高","id":"5390642eea8348a718c80a4b"}]}},
        {"topic":"三角形的中线与角平分线","pre":{"activities":[
            {"name":"三角形的中线","id":"539174e8e66322855fba5cb0"},
            {"name":"三角形的角平分线","id":"539922c514ae70d95adf65d0"}
        ]}},
        {"topic":"三角形的稳定性","pre":{"activities":[{"name":"三角形的稳定性和四边形的不稳定性","id":"53918622e6fc8ec26a141077"}]}},
        {"topic":"三角形的内角","pre":{"activities":[{"name":"三角形内角和定理证明","id":"539297216f936dff6e86c078"}]},"special":{"activities":[{"name":"三角形内角和定理应用","id":"5392c35dc48cc97c366bc765"}]}},
        {"topic":"三角形的外角","pre":{"activities":[
            {"name":"三角形外角的概念和性质","id":"5393d4050063d852037620f0"},
            {"name":"三角形外角的概念和性质应用","id":"539ace69c9a6ce5c6c6c2c43"}
        ]}},
        {"topic":"多边形","pre":{"activities":[{"name":"多边形的概念","id":"5394119cd1474cfa17fb1bd9"}]}},
        {"topic":"多边形对角线条数","pre":{"activities":[{"name":"多边形对角线条数","id":"53941efc44abf25b20f63528"}]}},
        {"topic":"多边形内角和","pre":{"activities":[{"name":"多边形内角和","id":"53944e5644abf25b20f635eb"}]}},
        {"topic":"多边形外角和","pre":{"activities":[{"name":"多边形外角和","id":"53966359b8233b3704e37e04"}]}}
    ]},{
    "chapter":"全等三角形", "array":[
        {"topic":"全等三角形的性质","pre":{"activities":[{"name":"全等三角形的性质","id":"53a107984353b42976e62dba"}]}},
        {"topic":"边边边判定定理（SSS）","pre":{"activities":[{"name":"边边边判定定理（SSS）","id":"53a10b654353b42976e62de3"}]}},
        {"topic":"边角边判定定理（SAS）","pre":{"activities":[{"name":"边角边判定定理（SAS）","id":"53b129224e02f85b4d60fd0b"}]}},
        {"topic":"角边角判定定理（ASA）","pre":{"activities":[{"name":"角边角判定定理（ASA）","id":"53b129264e02f85b4d60fd0c"}]}},
        {"topic":"角角边判定定理（AAS）","pre":{"activities":[{"name":"角角边判定定理（AAS）","id":"53b129284e02f85b4d60fd0d"}]}},
        {"topic":"斜边，直角边判定定理（HL）","pre":{"activities":[{"name":"斜边，直角边判定定理（HL）","id":"53b1292c4e02f85b4d60fd0e"}]}},
        {"topic":"角平分线的尺规作图法","pre":{"activities":[{"name":"角平分线的尺规作图法","id":"53a11b0c4353b42976e62e0e"}]}},
        {"topic":"角平分线的性质和判定","pre":{"activities":[{"name":"角平分线的性质和判定","id":"53b26e0cfb601327533dd007"}]}},
        {"topic":"全等模型—边"},
        {"topic":"全等模型—角"}
    ]},{
    "chapter":"整式的乘法与因式分解", "array":[
        {"topic":"同底数幂的乘法","pre":{"activities":[{"name":"同底数幂的乘法","id":"54059542ef73b666603a6917"}]}},
        {"topic":"幂的乘方","pre":{"activities":[{"name":"幂的乘方","id":"54059547ef73b666603a691a"}]},"special":{"activities":[{"name":"坑之同底数幂的乘法和幂的乘方","id":"5421168de61af7db487ec522"}]}},
        {"topic":"积的乘方","pre":{"activities":[{"name":"积的乘方","id":"54059551ef73b666603a691d"}]},"special":{"activities":[{"name":"来一起回到小学做巧算吧！","id":"5421169fda44c9e148cd0264"}]}},
        {"topic":"幂的运算性质总结","pre":{"activities":[{"name":"幂的运算性质总结","id":"540596bcef73b666603a6937"}]}},
        {"topic":"单项式乘以单项式","pre":{"activities":[{"name":"单项式乘以单项式","id":"540597a3ef73b666603a6949"}]},"special":{"activities":[{"name":"单项式乘法中的整体思想","id":"5421173de61af7db487ec526"}]}},
        {"topic":"单项式乘以多项式","pre":{"activities":[{"name":"单项式乘以多项式","id":"54059888ef73b666603a6986"}]},"special":{"activities":[{"name":"单项式乘以多项式","id":"54211750da44c9e148cd0268"}]}},
        {"topic":"多项式乘以多项式","pre":{"activities":[{"name":"多项式乘以多项式","id":"540598beef73b666603a699b"}]},"special":{"activities":[{"name":"多项式乘以多项式","id":"5421177ada44c9e148cd0269"}]}},
        {"topic":"同底数幂相除","pre":{"activities":[{"name":"同底数幂相除","id":"5417a56186d3c48052db1208"}]}},
        {"topic":"单项式除以单项式","pre":{"activities":[{"name":"单项式除以单项式","id":"540597b4ef73b666603a6951"}]}},
        {"topic":"多项式除以单项式","pre":{"activities":[{"name":"多项式除以单项式","id":"5405989aef73b666603a698b"}]},"special":{"activities":[{"name":"多项式除以单项式","id":"5421181fda44c9e148cd026d"}]}},
        {"topic":"平方差公式","pre":{"activities":[{"name":"平方差公式","id":"54059a01ef73b666603a69dd"}]},"special":{"activities":[{"name":"平方差公式","id":"5421187ae61af7db487ec532"}]}},
        {"topic":"完全平方公式","pre":{"activities":[{"name":"完全平方公式","id":"54059a18ef73b666603a69e3"}]},"special":{"activities":[{"name":"添括号","id":"54059a57ef73b666603a69f7"}]}},
        {"topic":"用公式法因式分解","pre":{"activities":[{"name":"用公式法因式分解","id":"54059ba5ef73b666603a6a1c"}]},"special":{"activities":[{"name":"公式法的运用","id":"542118dbda44c9e148cd0279"}]}},
        {"topic":"用提公因式法因式分解","pre":{"activities":[{"name":"用提公因式法因式分解","id":"54059beaef73b666603a6a24"}]},"special":{"activities":[{"name":"提公因式法和公式法的综合运用","id":"542118e8da44c9e148cd027a"}]}},
        {"topic":"十字相乘法","pre":{"activities":[
            {"name":"十字相乘法","id":"54059c04ef73b666603a6a29"},
            {"name":"十字相乘法进阶","id":"542294eebe3a5e4d770c36b1"}
        ]}}
    ]},{
    "chapter":"分式", "array":[
        {"topic":"分式的概念","pre":{"activities":[{"name":"分式的概念","id":"543e2cfac8cb2d6e1e97b6ca"}]},"special":{"activities":[{"name":"有意义与值为0","id":"5446015299fd66b33bd78614"}]}},
        {"topic":"分式的基本性质","pre":{"activities":[{"name":"分式的基本性质","id":"544601546ac7c5b93b5b0718"}]},"special":{"activities":[{"name":"分式的基本性质","id":"54460157aa3a66c03b2bfb9f"}]}},
        {"topic":"分式的约分与通分","pre":{"activities":[
            {"name":"分式的约分","id":"5446015a8a36fb943bc9376f"},
            {"name":"分式的通分","id":"544dc34ebec68b06178382bb"}]},"special":{"activities":[
            {"name":"分式的通分和约分","id":"5446016299fd66b33bd78615"}]}},
        {"topic":"分式的乘除与乘方","pre":{"activities":[
            {"name":"分式的乘除","id":"543e2d014dc9606c1eb3af53"},
            {"name":"分式的乘方","id":"54474ef7e02c67ed1a1285c7"}
        ]}},
        {"topic":"负数指数幂与科学记数法","pre":{"activities":[
            {"name":"负数指数幂","id":"543e2d034dc9606c1eb3af54"},
            {"name":"科学记数法","id":"5447602f2a90b9e51afbb175"}
        ]}},
        {"topic":"分式的加减","pre":{"activities":[{"name":"分式的加减","id":"544600d9bb5bd69a3b46167d"}]},"special":{"activities":[{"name":"分式的加减乘除混合运算","id":"544600dd136818a63b3a5fda"}]}},
        {"topic":"整体代入思想","pre":{"activities":[{"name":"整体代入思想","id":"544600e1fd0363ac3b91065e"}]}},
        {"topic":"分式方程","pre":{"activities":[{"name":"分式方程","id":"543e2d0c4dc9606c1eb3af56"}]},"special":{"activities":[{"name":"分式方程的解","id":"543e2d10c8cb2d6e1e97b6ce"}]}},
        {"topic":"分式方程应用题","pre":{"activities":[{"name":"分式方程应用题","id":"5446000ebb5bd69a3b46167c"}]}}
    ]},{
    "chapter":"二次根式", "array":[
        {"topic":"二次根式的定义","pre":{"activities":[{"name":"二次根式的定义","id":"5476e112202eece7320da6a1"}]},"special":{"activities":[{"name":"有意义与非负性","id":"5476e11746c0e3ab3248e49f"}]}},
        {"topic":"根的方与方的根","pre":{"activities":[{"name":"根的方与方的根","id":"5476e114964f88c932a64b27"}]},"special":{"activities":[{"name":"二次根式性质应用","id":"5476e119202eece7320da6a2"}]}},
        {"topic":"二次根式的乘法","pre":{"activities":[{"name":"二次根式的乘法","id":"5476e140f4978ef632cb4eef"}]},"special":{"activities":[{"name":"根式化简怪题","id":"5476e14446c0e3ab3248e7b8"}]}},
        {"topic":"二次根式的除法","pre":{"activities":[
            {"name":"二次根式的除法","id":"5476e14846c0e3ab3248e7ba"},
            {"name":"最简二次根式","id":"5476e14be0614c9c32715ce3"}]},"special":{"activities":[
            {"name":"根式运算技巧——平方差公式","id":"5476e13446c0e3ab3248e74b"}]}},
        {"topic":"二次根式的加减","pre":{"activities":[{"name":"二次根式的加减","id":"5476e16146c0e3ab3248e7bd"}]}}
    ]}];

db.chapters.drop();
db.topics.drop();
db.tasks.drop();
db.activities.drop();
db.videos.drop();
db.problems.drop();

db.createCollection("chapters");
db.createCollection("topics");
db.createCollection("tasks");
db.createCollection("activities");
db.createCollection("videos");
db.createCollection("problems");

var locateLesson = function(chapter, lessonid){
    for (var i=0,  lola=chapter.layers.length; i < lola; i++) {
        for (var j=0,  lole=chapter.layers[i].lessons.length; j < lole; j++) {
            if(chapter.layers[i].lessons[j]._id == lessonid)
                return chapter.layers[i].lessons[j];
        }
    }
    return null;
};

var locateActivity = function(lesson, type){
    for (var i=0,  loa=lesson.activities.length; i < loa; i++) {
        if(lesson.activities[i].type == type){
            return lesson.activities[i];
        }
    }
    return null;
}

var foo = function(task, taskid, chapter){// create topics
    for (var i=0,  loa=task.activities.length; i < loa; i++) {
        var activity = task.activities[i];
        var activityid = activity.id;
        var lesson = locateLesson(chapter, activityid);
        var video = locateActivity(lesson, "video");
        video.url = video.video.url;
        var problem = locateActivity(lesson, "gonggu");
        db.tasks.update({_id:taskid},{$push:{activities:lesson._id}});
        db.activities.save({_id:lesson._id, name:activity.name, seq: NumberInt(i+1),
            //lesson: lesson,
            videos: [video._id],
            task: taskid});
        if(lesson.summary_img){
            db.activities.update({_id:lesson._id},{$set:{icon: lesson.summary_img}});
        }
        db.videos.save(video);

        if(problem){
            db.problems.insert(problem.problems);
            var idsofprob = [];
            for (var j=0,  lop=problem.problems.length; j < lop; j++) {
                idsofprob.push(problem.problems[j]._id);
            }
            db.activities.update({_id:lesson._id},{$set:{problems: idsofprob,
                bloods:NumberInt(problem.blood)
            }});
        }
    }
};


for (var i=0,  loc=chapters.length; i < loc; i++) {
    var cursor = db.course.find({"name":chapters[i].chapter},{_id:1,name:1,description:1, bimg:1, layers:1});
    while ( cursor.hasNext() ) {
        chapter = cursor.next();

        // create chapters
        db.chapters.save({_id:chapter._id, name:chapter.name, desc: chapter.description,
            seq: NumberInt(i+1), icon: chapter.bimg, topics:[] });

        // create topics
        for (var j=0,  lot=chapters[i].array.length; j < lot; j++) {
            var topicid = new ObjectId();
            db.chapters.update({_id:chapter._id},{$push:{topics:topicid}});
            var topic = chapters[i].array[j];
            db.topics.save({_id:topicid, name:topic.topic, seq: NumberInt(j+1), chapter: chapter._id, tasks:[], desc:""});

            // create yuxi tasks
            if(topic.pre){
                var taskid = new ObjectId();
                db.topics.update({_id:topicid},{$push:{tasks:taskid}});
                var task = topic.pre;
                db.tasks.save({_id:taskid, seq: NumberInt(1), topic: topicid,
                    chapter:chapter._id, activities:[], type:"elementary"});
                foo(task, taskid, chapter);
            }

            // create texun tasks
            if(topic.special){
                var taskid = new ObjectId();
                db.topics.update({_id:topicid},{$push:{tasks:taskid}});
                var task = topic.special;
                db.tasks.save({_id:taskid, seq: NumberInt(2), topic: topicid,
                    chapter: chapter._id, activities:[], type:"advanced"});
                foo(task, taskid, chapter);
            }
        }
    }
}